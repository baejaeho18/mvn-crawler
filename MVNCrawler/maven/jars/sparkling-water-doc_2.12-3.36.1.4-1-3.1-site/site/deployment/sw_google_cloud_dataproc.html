

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Running Sparkling Water on Google Cloud Dataproc &mdash; H2O Sparkling Water 3.36.1.4-1-3.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/contentui.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using Sparkling Water with Microsoft Azure HDInsight - Beta" href="azure_hdi.html" />
    <link rel="prev" title="Download H2O Logs from Databricks Cloud" href="databricks_logs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.36.1.4-1-3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About Sparkling Water</a></li>
<li class="toctree-l1"><a class="reference internal" href="../typical_use_case.html">Typical Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Sparkling Water Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/install_and_start.html">Installing and Starting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/configuration.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="deployment.html">Deployment</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="backends.html">Sparkling Water Backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="load_mojo.html">Importing H2O MOJOs from H2O-3</a></li>
<li class="toctree-l2"><a class="reference internal" href="load_mojo_pipeline.html">Importing MOJO Pipelines from Driverless AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="pysparkling_pipeline.html">Deploying PySparkling Pipeline Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="aws_emr.html">Use Sparkling Water with Amazon EMR</a></li>
<li class="toctree-l2"><a class="reference internal" href="aws_emr_edge_node.html">Use Sparkling Water with Amazon EMR from the Edge Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="terraform_emr.html">Start Sparkling Water on Amazon EMR using our Terraform Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="kubernetes.html">Running Sparkling Water in Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="sw_azure_dbc.html">Running Sparkling Water on Databricks Azure Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="rsparkling_azure_dbc.html">Running RSparkling on Databricks Azure Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="pysparkling_azure_dbc.html">Running PySparkling on Databricks Azure Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="databricks_logs.html">Download H2O Logs from Databricks Cloud</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running Sparkling Water on Google Cloud Dataproc</a></li>
<li class="toctree-l2"><a class="reference internal" href="azure_hdi.html">Using Sparkling Water with Microsoft Azure HDInsight - Beta</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_on_windows.html">Use Sparkling Water in Windows Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="rsparkling_on_windows.html">Use RSparkling in Windows Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="use_on_zeppelin.html">Sparkling Water and Zeppelin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ml/ml.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/metrics.html">Metric Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_details/model_details.html">Model Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameters/parameters.html">Algorithm Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorials.html">How to…</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devel/devel.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pysparkling.html">PySparkling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rsparkling.html">RSparkling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">H2O Sparkling Water</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="deployment.html">Deployment</a> &raquo;</li>
        
      <li>Running Sparkling Water on Google Cloud Dataproc</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/deployment/sw_google_cloud_dataproc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="running-sparkling-water-on-google-cloud-dataproc">
<h1>Running Sparkling Water on Google Cloud Dataproc<a class="headerlink" href="#running-sparkling-water-on-google-cloud-dataproc" title="Permalink to this headline">¶</a></h1>
<p>This section describes how to run Sparkling Water on <a class="reference external" href="https://cloud.google.com/dataproc/docs/concepts/overview">Google Cloud Dataproc</a>.
It is meant to get you up and running with Sparkling Water on Google Cloud Dataproc as fast as possible so you can try it out.
For further usage and productionizing some adjustments like <a class="reference external" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/init-actions">initialization actions</a> will be required.
In this tutorial we will use Dataproc image version 2.0-debian10 which has Spark 3.1 and Scala 2.12.</p>
<ol class="arabic simple">
<li><p>Install the <a class="reference external" href="https://cloud.google.com/sdk/docs/install">Google Cloud SDK</a>. Login to your account.</p></li>
<li><p>Download <a class="reference external" href="http://h2o-release.s3.amazonaws.com/sparkling-water/spark-3.1/latest.html">Sparkling water</a>.</p></li>
<li><p>Create a Google Cloud Dataproc cluster.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DATAPROC_CLUSTER_NAME</span><span class="o">=</span><span class="s1">&#39;sparkling-water-test&#39;</span>
<span class="nv">GCP_REGION</span><span class="o">=</span><span class="s1">&#39;europe-central2&#39;</span>

gcloud dataproc clusters create <span class="nv">$DATAPROC_CLUSTER_NAME</span> <span class="se">\</span>
--region <span class="nv">$GCP_REGION</span> <span class="se">\</span>
--image-version <span class="m">2</span>.0-debian10 <span class="se">\</span>
--num-workers <span class="m">3</span> <span class="se">\</span>
--properties<span class="o">=</span><span class="s1">&#39;^#^dataproc:pip.packages=tabulate==0.8.3,requests==2.21.0,future==0.17.1&#39;</span>
</pre></div>
</div>
<div class="content-tabs docutils container">
<div class="tab-content docutils container" id="tab-Scala">
<p class="tab-title">Scala</p>
<p>Set the variables.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># we need spark jars to compile the example</span>
<span class="nv">SPARK_JARS</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$SPARK_HOME</span><span class="s2">&quot;</span>/jars/*.jar <span class="p">|</span> tr <span class="s1">&#39; &#39;</span> <span class="s1">&#39;:&#39;</span><span class="k">)</span>
<span class="nv">SPARKLING_WATER_JAR</span><span class="o">=</span><span class="s1">&#39;sparkling-water-assembly_2.12-3.36.1.4-1-3.1-all.jar&#39;</span>
</pre></div>
</div>
<p>Copy the example job source into a file named SparklingWaterGcpExampleJob.scala</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">java.net.URI</span>
<span class="k">import</span> <span class="nn">ai.h2o.sparkling._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.SparkFiles</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span>

<span class="k">object</span> <span class="nc">SparklingWaterGcpExampleJob</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="c1">// start the cluster</span>
  <span class="k">val</span> <span class="n">spark</span> <span class="k">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="o">(</span><span class="s">&quot;Sparkling water example&quot;</span><span class="o">).</span><span class="n">getOrCreate</span><span class="o">()</span>
  <span class="k">import</span> <span class="nn">spark.implicits._</span>
  <span class="k">val</span> <span class="n">hc</span> <span class="k">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="o">()</span>

  <span class="k">val</span> <span class="n">expectedClusterSize</span> <span class="k">=</span> <span class="mi">3</span>
  <span class="k">val</span> <span class="n">clusterSize</span> <span class="k">=</span> <span class="n">hc</span><span class="o">.</span><span class="n">getH2ONodes</span><span class="o">().</span><span class="n">length</span>
  <span class="n">require</span><span class="o">(</span><span class="n">clusterSize</span> <span class="o">!=</span> <span class="n">expectedClusterSize</span><span class="o">,</span> <span class="s">s&quot;H2O cluster should be of size </span><span class="si">$expectedClusterSize</span><span class="s"> but is </span><span class="si">$clusterSize</span><span class="s">&quot;</span><span class="o">)</span>

  <span class="c1">// prepare the data</span>
  <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">addFile</span><span class="o">(</span><span class="s">&quot;https://raw.githubusercontent.com/h2oai/sparkling-water/master/examples/smalldata/prostate/prostate.csv&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">frame</span> <span class="k">=</span> <span class="n">H2OFrame</span><span class="o">(</span><span class="k">new</span> <span class="nc">URI</span><span class="o">(</span><span class="s">&quot;file://&quot;</span> <span class="o">+</span> <span class="nc">SparkFiles</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;prostate.csv&quot;</span><span class="o">)))</span>
  <span class="k">val</span> <span class="n">sparkDF</span> <span class="k">=</span> <span class="n">hc</span><span class="o">.</span><span class="n">asSparkFrame</span><span class="o">(</span><span class="n">frame</span><span class="o">).</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;CAPSULE&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;CAPSULE&quot;</span> <span class="n">cast</span> <span class="s">&quot;string&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="nc">Array</span><span class="o">(</span><span class="n">trainingDF</span><span class="o">,</span> <span class="n">testingDF</span><span class="o">)</span> <span class="k">=</span> <span class="n">sparkDF</span><span class="o">.</span><span class="n">randomSplit</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="mf">0.8</span><span class="o">,</span> <span class="mf">0.2</span><span class="o">))</span>

  <span class="c1">// train the model</span>
  <span class="k">import</span> <span class="nn">ai.h2o.sparkling.ml.algos.H2OGBM</span>
  <span class="k">val</span> <span class="n">estimator</span> <span class="k">=</span> <span class="k">new</span> <span class="n">H2OGBM</span><span class="o">().</span><span class="n">setLabelCol</span><span class="o">(</span><span class="s">&quot;CAPSULE&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">model</span> <span class="k">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="o">(</span><span class="n">trainingDF</span><span class="o">)</span>

  <span class="c1">// run predictions</span>
  <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">testingDF</span><span class="o">).</span><span class="n">collect</span><span class="o">()</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Compile the code into a jar file having Spark and Sparkling Water on the classpath.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">EXAMPLE_JOB_JAR</span><span class="o">=</span><span class="s1">&#39;sparkling-water-gcp-example-job.jar&#39;</span>
scalac SparklingWaterGcpExampleJob.scala <span class="se">\</span>
      -d <span class="nv">$EXAMPLE_JOB_JAR</span> <span class="se">\</span>
      -classpath <span class="s2">&quot;</span><span class="nv">$SPARKLING_WATER_JAR</span><span class="s2">:</span><span class="nv">$SPARK_JARS</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Submit the job to the cluster.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcloud dataproc <span class="nb">jobs</span> submit spark <span class="se">\</span>
--class<span class="o">=</span>SparklingWaterGcpExampleJob <span class="se">\</span>
--cluster<span class="o">=</span><span class="nv">$DATAPROC_CLUSTER_NAME</span> <span class="se">\</span>
--region<span class="o">=</span><span class="nv">$GCP_REGION</span> <span class="se">\</span>
--jars <span class="s2">&quot;</span><span class="nv">$SPARKLING_WATER_JAR</span><span class="s2">,</span><span class="nv">$EXAMPLE_JOB_JAR</span><span class="s2">&quot;</span> <span class="se">\</span>
--properties<span class="o">=</span>spark.dynamicAllocation.enabled<span class="o">=</span>false,spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span>,spark.executor.instances<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
</div>
<div class="tab-content docutils container" id="tab-Python">
<p class="tab-title">Python</p>
<p>Set the variables.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYSPARKLING_ZIP</span><span class="o">=</span><span class="s1">&#39;h2o_pysparkling_3.1-3.36.1.4-1-3.1.zip&#39;</span>
</pre></div>
</div>
<p>Copy the example job source into a file named sparkling_water_gcp_example_job.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysparkling</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">import</span> <span class="nn">h2o</span>

<span class="c1"># start the cluster</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Sparkling water example&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">hc</span> <span class="o">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">h2o</span><span class="o">.</span><span class="n">cluster</span><span class="p">()</span><span class="o">.</span><span class="n">cloud_size</span> <span class="o">==</span> <span class="mi">3</span>

<span class="c1"># prepare the data</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">h2o</span><span class="o">.</span><span class="n">import_file</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/h2oai/sparkling-water/master/examples/smalldata/prostate/prostate.csv&quot;</span><span class="p">)</span>
<span class="n">sparkDF</span> <span class="o">=</span> <span class="n">hc</span><span class="o">.</span><span class="n">asSparkFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<span class="n">sparkDF</span> <span class="o">=</span> <span class="n">sparkDF</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;CAPSULE&quot;</span><span class="p">,</span> <span class="n">sparkDF</span><span class="o">.</span><span class="n">CAPSULE</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">))</span>
<span class="p">[</span><span class="n">trainingDF</span><span class="p">,</span> <span class="n">testingDF</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparkDF</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># train the model</span>
<span class="kn">from</span> <span class="nn">pysparkling.ml</span> <span class="kn">import</span> <span class="n">H2OGBM</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">H2OGBM</span><span class="p">(</span><span class="n">labelCol</span> <span class="o">=</span> <span class="s2">&quot;CAPSULE&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainingDF</span><span class="p">)</span>

<span class="c1"># run predictions</span>
<span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">testingDF</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
<p>Submit the job to the cluster.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcloud dataproc <span class="nb">jobs</span> submit pyspark sparkling_water_gcp_example_job.py <span class="se">\</span>
--cluster<span class="o">=</span><span class="nv">$DATAPROC_CLUSTER_NAME</span> <span class="se">\</span>
--region<span class="o">=</span><span class="nv">$GCP_REGION</span> <span class="se">\</span>
--py-files <span class="nv">$PYSPARKLING_ZIP</span> <span class="se">\</span>
--properties<span class="o">=</span>spark.dynamicAllocation.enabled<span class="o">=</span>false,spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span>,spark.executor.instances<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="azure_hdi.html" class="btn btn-neutral float-right" title="Using Sparkling Water with Microsoft Azure HDInsight - Beta" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="databricks_logs.html" class="btn btn-neutral float-left" title="Download H2O Logs from Databricks Cloud" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020 H2O.ai
      <span class="lastupdated">
        Last updated on Aug 04, 2022.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>