

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Running Sparkling Water in Kubernetes &mdash; H2O Sparkling Water 3.36.1.4-1-3.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/contentui.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running Sparkling Water on Databricks Azure Cluster" href="sw_azure_dbc.html" />
    <link rel="prev" title="Start Sparkling Water on Amazon EMR using our Terraform Template" href="terraform_emr.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.36.1.4-1-3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About Sparkling Water</a></li>
<li class="toctree-l1"><a class="reference internal" href="../typical_use_case.html">Typical Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Sparkling Water Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/install_and_start.html">Installing and Starting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/configuration.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="deployment.html">Deployment</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="backends.html">Sparkling Water Backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="load_mojo.html">Importing H2O MOJOs from H2O-3</a></li>
<li class="toctree-l2"><a class="reference internal" href="load_mojo_pipeline.html">Importing MOJO Pipelines from Driverless AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="pysparkling_pipeline.html">Deploying PySparkling Pipeline Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="aws_emr.html">Use Sparkling Water with Amazon EMR</a></li>
<li class="toctree-l2"><a class="reference internal" href="aws_emr_edge_node.html">Use Sparkling Water with Amazon EMR from the Edge Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="terraform_emr.html">Start Sparkling Water on Amazon EMR using our Terraform Template</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running Sparkling Water in Kubernetes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#internal-backend">Internal Backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manual-mode-of-external-backend">Manual Mode of External Backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="#automatic-mode-of-external-backend">Automatic Mode of External Backend</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sw_azure_dbc.html">Running Sparkling Water on Databricks Azure Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="rsparkling_azure_dbc.html">Running RSparkling on Databricks Azure Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="pysparkling_azure_dbc.html">Running PySparkling on Databricks Azure Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="databricks_logs.html">Download H2O Logs from Databricks Cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="sw_google_cloud_dataproc.html">Running Sparkling Water on Google Cloud Dataproc</a></li>
<li class="toctree-l2"><a class="reference internal" href="azure_hdi.html">Using Sparkling Water with Microsoft Azure HDInsight - Beta</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_on_windows.html">Use Sparkling Water in Windows Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="rsparkling_on_windows.html">Use RSparkling in Windows Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="use_on_zeppelin.html">Sparkling Water and Zeppelin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ml/ml.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/metrics.html">Metric Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_details/model_details.html">Model Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameters/parameters.html">Algorithm Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorials.html">How to…</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devel/devel.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pysparkling.html">PySparkling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rsparkling.html">RSparkling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">H2O Sparkling Water</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="deployment.html">Deployment</a> &raquo;</li>
        
      <li>Running Sparkling Water in Kubernetes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/deployment/kubernetes.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="running-sparkling-water-in-kubernetes">
<h1>Running Sparkling Water in Kubernetes<a class="headerlink" href="#running-sparkling-water-in-kubernetes" title="Permalink to this headline">¶</a></h1>
<p>Sparkling Water can be executed inside the Kubernetes cluster. Sparkling Water supports Kubernetes since Spark version 2.4.</p>
<p>Before we start, please check the following:</p>
<ol class="arabic simple">
<li><p>Please make sure we are familiar with how to run Spark on Kubernetes at
<a class="reference external" href="https://spark.apache.org/docs/3.1.3/running-on-kubernetes.html">Spark Kubernetes documentation</a>.</p></li>
<li><p>Ensure that we have a working Kubernetes Cluster and <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> installed</p></li>
<li><p>Ensure we have <code class="docutils literal notranslate"><span class="pre">SPARK_HOME</span></code> set up to a home directory of our Spark distribution of version 3.1.3</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">cluster-info</span></code> to obtain Kubernetes master URL.</p></li>
<li><p>Have internet connection so Kubernetes can download Sparkling Water docker images</p></li>
<li><p>If we have some non-default network policies applied to the namespace where Sparkling Water is supposed to run,
make sure that the following ports are exposed: all Spark ports and ports 54321 and 54322 as these are
also necessary by H2O to be able to communicate.</p></li>
</ol>
<p>The examples below are using the default Kubernetes namespace which we enable for Spark as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl create clusterrolebinding default --clusterrole<span class="o">=</span>edit --serviceaccount<span class="o">=</span>default:default --namespace<span class="o">=</span>default
</pre></div>
</div>
<p>We can also use different namespace setup for Spark. In that case please don’t forget to pass
<code class="docutils literal notranslate"><span class="pre">--conf</span> <span class="pre">spark.kubernetes.authenticate.driver.serviceAccountName=serviceName</span></code> to our Spark commands.</p>
<div class="section" id="internal-backend">
<h2>Internal Backend<a class="headerlink" href="#internal-backend" title="Permalink to this headline">¶</a></h2>
<p>In the internal backend of Sparkling Water, we need to pass the option <code class="docutils literal notranslate"><span class="pre">spark.scheduler.minRegisteredResourcesRatio=1</span></code>
to our Spark job invocation. This ensures that Spark waits for all resources and therefore Sparkling Water will
start H2O on all requested executors.</p>
<p>Dynamic allocation must be disabled in Spark.</p>
<div class="content-tabs docutils container">
<div class="tab-content docutils container" id="tab-Scala">
<p class="tab-title">Scala</p>
<p>Both cluster and client deployment modes of Kubernetes are supported.</p>
<p><strong>To submit Scala job in a cluster mode, run:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode cluster <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--class ai.h2o.sparkling.KubernetesTest <span class="se">\</span>
local:///opt/sparkling-water/tests/kubernetesTest.jar
</pre></div>
</div>
<p><strong>To start an interactive shell in a client mode:</strong></p>
<ol class="arabic simple">
<li><p>Create Headless service so Spark executors can reach the driver node</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: sparkling-water-app</span>
<span class="s">spec:</span>
<span class="s">  clusterIP: &quot;None&quot;</span>
<span class="s">  selector:</span>
<span class="s">    spark-driver-selector: sparkling-water-app</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Start pod from where we run the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 -- /bin/bash
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Inside the container, start the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-shell <span class="se">\</span>
 --master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
 --deploy-mode client <span class="se">\</span>
 --conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
 --conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
 --conf spark.executor.instances<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
 --conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
 --conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Inside the shell, run:</p></li>
</ol>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">ai.h2o.sparkling._</span>
<span class="k">val</span> <span class="n">hc</span> <span class="k">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="o">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>To access flow, we need to enable port-forwarding from the driver pod:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl port-forward sparkling-water-app <span class="m">54321</span>:54321
</pre></div>
</div>
<p><strong>To submit a batch job using client mode:</strong></p>
<p>First, create the headless service as mentioned in the step 1 above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 -- <span class="se">\</span>
<span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--class ai.h2o.sparkling.KubernetesTest <span class="se">\</span>
local:///opt/sparkling-water/tests/kubernetesTest.jar
</pre></div>
</div>
</div>
<div class="tab-content docutils container" id="tab-Python">
<p class="tab-title">Python</p>
<p>Both cluster and client deployment modes of Kubernetes are supported.</p>
<p><strong>To submit Python job in a cluster mode, run:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode cluster <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
local:///opt/sparkling-water/tests/initTest.py
</pre></div>
</div>
<p><strong>To start an interactive shell in a client mode:</strong></p>
<ol class="arabic simple">
<li><p>Create Headless service so Spark executors can reach the driver node:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: sparkling-water-app</span>
<span class="s">spec:</span>
<span class="s">  clusterIP: &quot;None&quot;</span>
<span class="s">  selector:</span>
<span class="s">    spark-driver-selector: sparkling-water-app</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Start pod from where we run the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 -- /bin/bash
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Inside the container, start the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/pyspark <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Inside the shell, run:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysparkling</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">hc</span> <span class="o">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>To access flow, we need to enable port-forwarding from the driver pod as:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl port-forward sparkling-water-app <span class="m">54321</span>:54321
</pre></div>
</div>
<p><strong>To submit a batch job using client mode:</strong></p>
<p>First, create the headless service as mentioned in the step 1 above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 -- <span class="se">\</span>
<span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
local:///opt/sparkling-water/tests/initTest.py
</pre></div>
</div>
</div>
<div class="tab-content docutils container" id="tab-R">
<p class="tab-title">R</p>
<p>First, make sure that RSparkling is installed on the node we want to run RSparkling from.
You can install RSparkling as:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download, install, and initialize the H2O package for R.</span>
<span class="c1"># In this case we are using rel-zumbo 4 (3.36.1.4)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;h2o&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/h2o/rel-zumbo/4/R&quot;</span><span class="p">)</span>

<span class="c1"># Download, install, and initialize the RSparkling</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;rsparkling&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/sparkling-water/spark-3.1/3.36.1.4-1-3.1/R&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To start <code class="docutils literal notranslate"><span class="pre">H2OContext</span></code> in an interactive shell, run the following code in R or RStudio:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rsparkling</span><span class="p">)</span>
<span class="n">config</span> <span class="o">&lt;-</span> <span class="nf">spark_config_kubernetes</span><span class="p">(</span><span class="s">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span><span class="p">,</span>
                 <span class="n">image</span> <span class="o">=</span> <span class="s">&quot;h2oai/sparkling-water-r:3.36.1.4-1-3.1&quot;</span><span class="p">,</span>
                 <span class="n">account</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
                 <span class="n">executors</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span>
                 <span class="n">conf</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="s">&quot;spark.kubernetes.file.upload.path&quot;</span><span class="o">=</span><span class="s">&quot;file:///tmp&quot;</span><span class="p">),</span>
                 <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.1.3&quot;</span><span class="p">,</span>
                 <span class="n">ports</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">8880</span><span class="p">,</span> <span class="m">8881</span><span class="p">,</span> <span class="m">4040</span><span class="p">,</span> <span class="m">54321</span><span class="p">))</span>
<span class="n">config</span><span class="p">[</span><span class="s">&quot;spark.home&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">Sys.getenv</span><span class="p">(</span><span class="s">&quot;SPARK_HOME&quot;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">&lt;-</span> <span class="nf">spark_connect</span><span class="p">(</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">,</span> <span class="n">spark_home</span> <span class="o">=</span> <span class="nf">Sys.getenv</span><span class="p">(</span><span class="s">&quot;SPARK_HOME&quot;</span><span class="p">))</span>
<span class="n">hc</span> <span class="o">&lt;-</span> <span class="nf">H2OContext.getOrCreate</span><span class="p">()</span>
<span class="nf">spark_disconnect</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also submit RSparkling batch job. In that case, create a file called <cite>batch.R</cite> with the content
from the code box above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Rscript --default-packages<span class="o">=</span>methods,utils batch.R
</pre></div>
</div>
<p>Note: In the case of RSparkling, SparklyR automatically sets the Spark deployment mode and it is not possible to specify it.</p>
</div>
</div>
</div>
<div class="section" id="manual-mode-of-external-backend">
<h2>Manual Mode of External Backend<a class="headerlink" href="#manual-mode-of-external-backend" title="Permalink to this headline">¶</a></h2>
<p>Sparkling Water External backend can be also used in Kubernetes. First, we need to start
an external H2O backend on Kubernetes. To achieve this, please follow the steps on the
<a class="reference external" href="https://h2o-release.s3.amazonaws.com/h2o/rel-zumbo/4/docs-website/h2o-docs/welcome.html#kubernetes-integration/">H2O on Kubernetes Documentation</a> with
<strong>one important exception</strong>. The image to be used need to be <cite>h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1</cite> and not the base H2O image as mentioned in
H2O documentation as Sparkling Water enhances the H2O image with additional dependencies.</p>
<p>In order for Sparkling Water to be able to connect to the H2O cluster, we need to get the address of the leader node
of the H2O cluster. If we followed the H2O documentation on how to start H2O cluster on Kubernetes, the address is
<code class="docutils literal notranslate"><span class="pre">h2o-service.default.svc.cluster.local:54321</span></code> where the first part is the H2O headless service name and the second part is the name
of the namespace.</p>
<p>After we created the external H2O backend, we can connect to it from Sparkling Water clients as:</p>
<div class="content-tabs docutils container">
<div class="tab-content docutils container" id="tab-Scala">
<p class="tab-title">Scala</p>
<p>Both cluster and client deployment modes of Kubernetes are supported.</p>
<p><strong>To submit Scala job in a cluster mode, run:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode cluster <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>manual <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.cloud.representative<span class="o">=</span>h2o-service.default.svc.cluster.local:54321 <span class="se">\</span>
--conf spark.ext.h2o.cloud.name<span class="o">=</span>root <span class="se">\</span>
--class ai.h2o.sparkling.KubernetesTest <span class="se">\</span>
local:///opt/sparkling-water/tests/kubernetesTest.jar
</pre></div>
</div>
<p><strong>To start an interactive shell in a client mode:</strong></p>
<ol class="arabic simple">
<li><p>Create Headless service so Spark executors can reach the driver node</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: sparkling-water-app</span>
<span class="s">spec:</span>
<span class="s">  clusterIP: &quot;None&quot;</span>
<span class="s">  selector:</span>
<span class="s">    spark-driver-selector: sparkling-water-app</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Start pod from where we run the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 -- /bin/bash
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Inside the container, start the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-shell <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>manual <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.cloud.representative<span class="o">=</span>h2o-service.default.svc.cluster.local:54321 <span class="se">\</span>
--conf spark.ext.h2o.cloud.name<span class="o">=</span>root
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Inside the shell, run:</p></li>
</ol>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">ai.h2o.sparkling._</span>
<span class="k">val</span> <span class="n">hc</span> <span class="k">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="o">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>To access flow, we need to enable port-forwarding from the driver pod:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl port-forward sparkling-water-app <span class="m">54321</span>:54321
</pre></div>
</div>
<p><strong>To submit a batch job using client mode:</strong></p>
<p>First, create the headless service as mentioned in the step 1 above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 -- <span class="se">\</span>
<span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>manual <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.cloud.representative<span class="o">=</span>h2o-service.default.svc.cluster.local:54321 <span class="se">\</span>
--conf spark.ext.h2o.cloud.name<span class="o">=</span>root <span class="se">\</span>
--class ai.h2o.sparkling.KubernetesTest <span class="se">\</span>
local:///opt/sparkling-water/tests/kubernetesTest.jar
</pre></div>
</div>
</div>
<div class="tab-content docutils container" id="tab-Python">
<p class="tab-title">Python</p>
<p>Both cluster and client deployment modes of Kubernetes are supported.</p>
<p><strong>To submit Python job in a cluster mode, run:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode cluster <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>manual <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.cloud.representative<span class="o">=</span>h2o-service.default.svc.cluster.local:54321 <span class="se">\</span>
--conf spark.ext.h2o.cloud.name<span class="o">=</span>root <span class="se">\</span>
local:///opt/sparkling-water/tests/initTest.py
</pre></div>
</div>
<p><strong>To start an interactive shell in a client mode:</strong></p>
<ol class="arabic simple">
<li><p>Create Headless service so Spark executors can reach the driver node:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: sparkling-water-app</span>
<span class="s">spec:</span>
<span class="s">  clusterIP: &quot;None&quot;</span>
<span class="s">  selector:</span>
<span class="s">    spark-driver-selector: sparkling-water-app</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Start pod from where we run the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 -- /bin/bash
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Inside the container, start the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/pyspark <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>manual <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.cloud.representative<span class="o">=</span>h2o-service.default.svc.cluster.local:54321 <span class="se">\</span>
--conf spark.ext.h2o.cloud.name<span class="o">=</span>root
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Inside the shell, run:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysparkling</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">hc</span> <span class="o">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>To access flow, we need to enable port-forwarding from the driver pod as:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl port-forward sparkling-water-app <span class="m">54321</span>:54321
</pre></div>
</div>
<p><strong>To submit a batch job using client mode:</strong></p>
<p>First, create the headless service as mentioned in the step 1 above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 -- <span class="se">\</span>
<span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>manual <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.cloud.representative<span class="o">=</span>h2o-service.default.svc.cluster.local:54321 <span class="se">\</span>
--conf spark.ext.h2o.cloud.name<span class="o">=</span>root <span class="se">\</span>
local:///opt/sparkling-water/tests/initTest.py
</pre></div>
</div>
</div>
<div class="tab-content docutils container" id="tab-R">
<p class="tab-title">R</p>
<p>First, make sure that RSparkling is installed on the node we want to run RSparkling from.
You can install RSparkling as:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download, install, and initialize the H2O package for R.</span>
<span class="c1"># In this case we are using rel-zumbo 4 (3.36.1.4)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;h2o&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/h2o/rel-zumbo/4/R&quot;</span><span class="p">)</span>

<span class="c1"># Download, install, and initialize the RSparkling</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;rsparkling&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/sparkling-water/spark-3.1/3.36.1.4-1-3.1/R&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To start <code class="docutils literal notranslate"><span class="pre">H2OContext</span></code> in an interactive shell, run the following code in R or RStudio:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rsparkling</span><span class="p">)</span>
<span class="n">config</span> <span class="o">&lt;-</span> <span class="nf">spark_config_kubernetes</span><span class="p">(</span><span class="s">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span><span class="p">,</span>
                 <span class="n">image</span> <span class="o">=</span> <span class="s">&quot;h2oai/sparkling-water-r:3.36.1.4-1-3.1&quot;</span><span class="p">,</span>
                 <span class="n">account</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
                 <span class="n">executors</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span>
                 <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.1.3&quot;</span><span class="p">,</span>
                 <span class="n">conf</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span>
                         <span class="s">&quot;spark.ext.h2o.backend.cluster.mode&quot;</span><span class="o">=</span><span class="s">&quot;external&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.external.start.mode&quot;</span><span class="o">=</span><span class="s">&quot;manual&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.external.memory&quot;</span><span class="o">=</span><span class="s">&quot;2G&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.cloud.representative&quot;</span><span class="o">=</span><span class="s">&quot;h2o-service.default.svc.cluster.local:54321&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.cloud.name&quot;</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.kubernetes.file.upload.path&quot;</span><span class="o">=</span><span class="s">&quot;file:///tmp&quot;</span><span class="p">),</span>
                 <span class="n">ports</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">8880</span><span class="p">,</span> <span class="m">8881</span><span class="p">,</span> <span class="m">4040</span><span class="p">,</span> <span class="m">54321</span><span class="p">))</span>
<span class="n">config</span><span class="p">[</span><span class="s">&quot;spark.home&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">Sys.getenv</span><span class="p">(</span><span class="s">&quot;SPARK_HOME&quot;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">&lt;-</span> <span class="nf">spark_connect</span><span class="p">(</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">,</span> <span class="n">spark_home</span> <span class="o">=</span> <span class="nf">Sys.getenv</span><span class="p">(</span><span class="s">&quot;SPARK_HOME&quot;</span><span class="p">))</span>
<span class="n">hc</span> <span class="o">&lt;-</span> <span class="nf">H2OContext.getOrCreate</span><span class="p">()</span>
<span class="nf">spark_disconnect</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also submit RSparkling batch job. In that case, create a file called <cite>batch.R</cite> with the content
from the code box above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Rscript --default-packages<span class="o">=</span>methods,utils batch.R
</pre></div>
</div>
<p>Note: In the case of RSparkling, SparklyR automatically sets the Spark deployment mode and it is not possible to specify it.</p>
</div>
</div>
</div>
<div class="section" id="automatic-mode-of-external-backend">
<h2>Automatic Mode of External Backend<a class="headerlink" href="#automatic-mode-of-external-backend" title="Permalink to this headline">¶</a></h2>
<p>In the automatic mode, Sparkling Water starts external H2O on Kubernetes automatically. The requirement is that the
driver node is configured to communicate with the Kubernetes cluster. Docker image for the external H2O backend
is specified using the <code class="docutils literal notranslate"><span class="pre">spark.ext.h2o.external.k8s.docker.image</span></code> option.</p>
<div class="content-tabs docutils container">
<div class="tab-content docutils container" id="tab-Scala">
<p class="tab-title">Scala</p>
<p>Both cluster and client deployment modes of Kubernetes are supported.</p>
<p><strong>To submit Scala job in a cluster mode, run:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode cluster <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>auto <span class="se">\</span>
--conf spark.ext.h2o.external.auto.start.backend<span class="o">=</span>kubernetes <span class="se">\</span>
--conf spark.ext.h2o.external.cluster.size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.external.k8s.docker.image<span class="o">=</span>h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1 <span class="se">\</span>
--class ai.h2o.sparkling.KubernetesTest <span class="se">\</span>
local:///opt/sparkling-water/tests/kubernetesTest.jar
</pre></div>
</div>
<p><strong>To start an interactive shell in a client mode:</strong></p>
<ol class="arabic simple">
<li><p>Create Headless service so Spark executors can reach the driver node</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: sparkling-water-app</span>
<span class="s">spec:</span>
<span class="s">  clusterIP: &quot;None&quot;</span>
<span class="s">  selector:</span>
<span class="s">    spark-driver-selector: sparkling-water-app</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Start pod from where we run the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 -- /bin/bash
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Inside the container, start the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-shell <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>auto <span class="se">\</span>
--conf spark.ext.h2o.external.auto.start.backend<span class="o">=</span>kubernetes <span class="se">\</span>
--conf spark.ext.h2o.external.cluster.size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.external.k8s.docker.image<span class="o">=</span>h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Inside the shell, run:</p></li>
</ol>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">ai.h2o.sparkling._</span>
<span class="k">val</span> <span class="n">hc</span> <span class="k">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="o">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>To access flow, we need to enable port-forwarding from the driver pod:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl port-forward sparkling-water-app <span class="m">54321</span>:54321
</pre></div>
</div>
<p><strong>To submit a batch job using client mode:</strong></p>
<p>First, create the headless service as mentioned in the step 1 above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 -- <span class="se">\</span>
<span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-scala:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>auto <span class="se">\</span>
--conf spark.ext.h2o.external.auto.start.backend<span class="o">=</span>kubernetes <span class="se">\</span>
--conf spark.ext.h2o.external.cluster.size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.external.k8s.docker.image<span class="o">=</span>h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1 <span class="se">\</span>
--class ai.h2o.sparkling.KubernetesTest <span class="se">\</span>
local:///opt/sparkling-water/tests/kubernetesTest.jar
</pre></div>
</div>
</div>
<div class="tab-content docutils container" id="tab-Python">
<p class="tab-title">Python</p>
<p>Both cluster and client deployment modes of Kubernetes are supported.</p>
<p><strong>To submit Python job in a cluster mode, run:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode cluster <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>auto <span class="se">\</span>
--conf spark.ext.h2o.external.auto.start.backend<span class="o">=</span>kubernetes <span class="se">\</span>
--conf spark.ext.h2o.external.cluster.size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.external.k8s.docker.image<span class="o">=</span>h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1 <span class="se">\</span>
local:///opt/sparkling-water/tests/initTest.py
</pre></div>
</div>
<p><strong>To start an interactive shell in a client mode:</strong></p>
<ol class="arabic simple">
<li><p>Create Headless service so Spark executors can reach the driver node:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: sparkling-water-app</span>
<span class="s">spec:</span>
<span class="s">  clusterIP: &quot;None&quot;</span>
<span class="s">  selector:</span>
<span class="s">    spark-driver-selector: sparkling-water-app</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Start pod from where we run the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 -- /bin/bash
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Inside the container, start the shell:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SPARK_HOME</span>/bin/pyspark <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>auto <span class="se">\</span>
--conf spark.ext.h2o.external.auto.start.backend<span class="o">=</span>kubernetes <span class="se">\</span>
--conf spark.ext.h2o.external.cluster.size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.external.k8s.docker.image<span class="o">=</span>h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Inside the shell, run:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysparkling</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">hc</span> <span class="o">=</span> <span class="n">H2OContext</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>To access flow, we need to enable port-forwarding from the driver pod as:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl port-forward sparkling-water-app <span class="m">54321</span>:54321
</pre></div>
</div>
<p><strong>To submit a batch job using client mode:</strong></p>
<p>First, create the headless service as mentioned in the step 1 above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run -n default -i --tty sparkling-water-app --restart<span class="o">=</span>Never --labels spark-driver-selector<span class="o">=</span>sparkling-water-app --image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 -- <span class="se">\</span>
<span class="nv">$SPARK_HOME</span>/bin/spark-submit <span class="se">\</span>
--master <span class="s2">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span> <span class="se">\</span>
--deploy-mode client <span class="se">\</span>
--conf spark.scheduler.minRegisteredResourcesRatio<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
--conf spark.kubernetes.container.image<span class="o">=</span>h2oai/sparkling-water-python:3.36.1.4-1-3.1 <span class="se">\</span>
--conf spark.executor.instances<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.driver.host<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.kubernetes.driver.pod.name<span class="o">=</span>sparkling-water-app <span class="se">\</span>
--conf spark.ext.h2o.backend.cluster.mode<span class="o">=</span>external <span class="se">\</span>
--conf spark.ext.h2o.external.start.mode<span class="o">=</span>auto <span class="se">\</span>
--conf spark.ext.h2o.external.auto.start.backend<span class="o">=</span>kubernetes <span class="se">\</span>
--conf spark.ext.h2o.external.cluster.size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
--conf spark.ext.h2o.external.memory<span class="o">=</span>2G <span class="se">\</span>
--conf spark.ext.h2o.external.k8s.docker.image<span class="o">=</span>h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1 <span class="se">\</span>
local:///opt/sparkling-water/tests/initTest.py
</pre></div>
</div>
</div>
<div class="tab-content docutils container" id="tab-R">
<p class="tab-title">R</p>
<p>First, make sure that RSparkling is installed on the node we want to run RSparkling from.
You can install RSparkling as:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download, install, and initialize the H2O package for R.</span>
<span class="c1"># In this case we are using rel-zumbo 4 (3.36.1.4)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;h2o&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/h2o/rel-zumbo/4/R&quot;</span><span class="p">)</span>

<span class="c1"># Download, install, and initialize the RSparkling</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;rsparkling&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/sparkling-water/spark-3.1/3.36.1.4-1-3.1/R&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To start <code class="docutils literal notranslate"><span class="pre">H2OContext</span></code> in an interactive shell, run the following code in R or RStudio:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rsparkling</span><span class="p">)</span>
<span class="n">config</span> <span class="o">&lt;-</span> <span class="nf">spark_config_kubernetes</span><span class="p">(</span><span class="s">&quot;k8s://KUBERNETES_ENDPOINT&quot;</span><span class="p">,</span>
                 <span class="n">image</span> <span class="o">=</span> <span class="s">&quot;h2oai/sparkling-water-r:3.36.1.4-1-3.1&quot;</span><span class="p">,</span>
                 <span class="n">account</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
                 <span class="n">executors</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span>
                 <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.1.3&quot;</span><span class="p">,</span>
                 <span class="n">conf</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span>
                         <span class="s">&quot;spark.ext.h2o.backend.cluster.mode&quot;</span><span class="o">=</span><span class="s">&quot;external&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.external.start.mode&quot;</span><span class="o">=</span><span class="s">&quot;auto&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.external.auto.start.backend&quot;</span><span class="o">=</span><span class="s">&quot;kubernetes&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.external.memory&quot;</span><span class="o">=</span><span class="s">&quot;2G&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.external.cluster.size&quot;</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.ext.h2o.external.k8s.docker.image&quot;</span><span class="o">=</span><span class="s">&quot;h2oai/sparkling-water-external-backend:3.36.1.4-1-3.1&quot;</span><span class="p">,</span>
                         <span class="s">&quot;spark.kubernetes.file.upload.path&quot;</span><span class="o">=</span><span class="s">&quot;file:///tmp&quot;</span><span class="p">),</span>
                 <span class="n">ports</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">8880</span><span class="p">,</span> <span class="m">8881</span><span class="p">,</span> <span class="m">4040</span><span class="p">,</span> <span class="m">54321</span><span class="p">))</span>
<span class="n">config</span><span class="p">[</span><span class="s">&quot;spark.home&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">Sys.getenv</span><span class="p">(</span><span class="s">&quot;SPARK_HOME&quot;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">&lt;-</span> <span class="nf">spark_connect</span><span class="p">(</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">,</span> <span class="n">spark_home</span> <span class="o">=</span> <span class="nf">Sys.getenv</span><span class="p">(</span><span class="s">&quot;SPARK_HOME&quot;</span><span class="p">))</span>
<span class="n">hc</span> <span class="o">&lt;-</span> <span class="nf">H2OContext.getOrCreate</span><span class="p">()</span>
<span class="nf">spark_disconnect</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also submit RSparkling batch job. In that case, create a file called <cite>batch.R</cite> with the content
from the code box above and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Rscript --default-packages<span class="o">=</span>methods,utils batch.R
</pre></div>
</div>
<p>Note: In the case of RSparkling, SparklyR automatically sets the Spark deployment mode and it is not possible to specify it.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="sw_azure_dbc.html" class="btn btn-neutral float-right" title="Running Sparkling Water on Databricks Azure Cluster" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="terraform_emr.html" class="btn btn-neutral float-left" title="Start Sparkling Water on Amazon EMR using our Terraform Template" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020 H2O.ai
      <span class="lastupdated">
        Last updated on Aug 04, 2022.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>