

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>RSparkling &mdash; H2O Sparkling Water 3.36.1.4-1-3.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/contentui.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/contentui.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Migration Guide" href="migration_guide.html" />
    <link rel="prev" title="PySparkling" href="pysparkling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.36.1.4-1-3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About Sparkling Water</a></li>
<li class="toctree-l1"><a class="reference internal" href="typical_use_case.html">Typical Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Sparkling Water Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="install/install_and_start.html">Installing and Starting</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment/deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="ml/ml.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics/metrics.html">Metric Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_details/model_details.html">Model Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameters/parameters.html">Algorithm Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/tutorials.html">How to…</a></li>
<li class="toctree-l1"><a class="reference internal" href="devel/devel.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="pysparkling.html">PySparkling</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">RSparkling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation-of-sparklyr-spark">Installation of SparklyR &amp; Spark</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-sparklyr">Install Sparklyr</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-spark-via-sparklyr">Install Spark via Sparklyr</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#install-h2o">Install H2O</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prepare-environment-for-h2o-installation">Prepare Environment for H2O Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-h2o-from-cran">Install H2O from CRAN</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-h2o-from-s3">Install H2O from S3</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#install-rsparkling">Install RSparkling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enable-rsparkling">Enable RSparkling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-spark">Starting Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-rsparkling">Using RSparkling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#specify-h2oconf">Specify H2OConf</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-h2ocontext">Create H2OContext</a></li>
<li class="toctree-l3"><a class="reference internal" href="#open-h2o-flow">Open H2O Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#h2o-with-spark-dataframes">H2O with Spark DataFrames</a></li>
<li class="toctree-l3"><a class="reference internal" href="#obtaining-logs">Obtaining Logs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disconnect-from-spark">Disconnect from Spark</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#machine-learning-with-rsparkling-h2o">Machine Learning with RSparkling &amp; H2O</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initialize-h2o">Initialize H2O</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-preparations">Data Preparations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-training">Model Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-performance">Model Performance:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#predictions">Predictions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#additional-resources">Additional Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="migration_guide.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">H2O Sparkling Water</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>RSparkling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/rsparkling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rsparkling">
<span id="id1"></span><h1>RSparkling<a class="headerlink" href="#rsparkling" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="Jointhechatathttps://gitter.im/h2oai/rsparkling?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img alt="Join the chat at https://gitter.im/h2oai/rsparkling" src="https://badges.gitter.im/Join%20Chat.svg" /></a> <a class="reference external" href="LICENSE"><img alt="License" src="https://img.shields.io/badge/License-Apache%202-blue.svg" /></a> <a class="reference external" href="https://github.com/h2oai/"><img alt="Powered by H2O.ai" src="https://img.shields.io/badge/powered%20by-h2oai-yellow.svg" /></a></p>
<p>The <strong>rsparkling</strong> R package is an extension package for <a class="reference external" href="http://spark.rstudio.com">sparklyr</a>
that creates an R front-end for the <a class="reference external" href="https://www.h2o.ai/sparkling-water/">Sparkling Water</a>
package from <a class="reference external" href="https://www.h2o.ai/">H2O</a>.
This provides an interface to H2O’s high performance, distributed machine learning algorithms on
Spark, using R.</p>
<p>This package implements basic functionality (creating an H2OContext, showing the H2O Flow
interface, and converting between Spark DataFrames and H2O Frames). The main purpose of
this package is to provide a connector between Sparklyr and H2O’s machine learning algorithms.</p>
<p>The <strong>rsparkling</strong> package uses <strong>sparklyr</strong> for Spark job deployment and initialization
of Sparkling Water. After that, the user can use the regular <strong>h2o</strong> R package for modeling. In the
following sections, we show how to install each of these packages.</p>
<div class="section" id="installation-of-sparklyr-spark">
<h2>Installation of SparklyR &amp; Spark<a class="headerlink" href="#installation-of-sparklyr-spark" title="Permalink to this headline">¶</a></h2>
<div class="section" id="install-sparklyr">
<h3>Install Sparklyr<a class="headerlink" href="#install-sparklyr" title="Permalink to this headline">¶</a></h3>
<p>We recommend the latest stable version of <a class="reference external" href="http://spark.rstudio.com/index.html">sparklyr</a>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;sparklyr&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="install-spark-via-sparklyr">
<h3>Install Spark via Sparklyr<a class="headerlink" href="#install-spark-via-sparklyr" title="Permalink to this headline">¶</a></h3>
<p><strong>RSparkling 3.36.1.4-1-3.1</strong> is built for 3.1.</p>
<p>The following command will install Spark 3.1.3:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">spark_install</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.1.3&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>NOTE</strong>: The previous command requires access to the internet. If you are not connected to the
internet/behind a firewall you can do the following:</p>
<ol class="arabic">
<li><p>Download <a class="reference external" href="https://spark.apache.org/downloads.html">Spark</a> (Pick any supported minor version for Spark 3.1)</p></li>
<li><p>Unzip Spark files</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">SPARK_HOME</span></code> environment variable to the location of the downloaded Spark folder in R as follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">Sys.setenv</span><span class="p">(</span><span class="n">SPARK_HOME</span><span class="o">=</span><span class="s">&quot;/path/to/spark&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="install-h2o">
<h2>Install H2O<a class="headerlink" href="#install-h2o" title="Permalink to this headline">¶</a></h2>
<div class="section" id="prepare-environment-for-h2o-installation">
<h3>Prepare Environment for H2O Installation<a class="headerlink" href="#prepare-environment-for-h2o-installation" title="Permalink to this headline">¶</a></h3>
<p><strong>RSparkling 3.36.1.4-1-3.1</strong> requires H2O of version 3.36.1.4.</p>
<p>It is advised to remove previously installed H2O versions and install H2O dependencies. The command bellow
can be used for this.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following two commands remove any previously installed H2O packages for R.</span>
<span class="nf">if </span><span class="p">(</span><span class="s">&quot;package:h2o&quot;</span> <span class="o">%in%</span> <span class="nf">search</span><span class="p">())</span> <span class="p">{</span> <span class="nf">detach</span><span class="p">(</span><span class="s">&quot;package:h2o&quot;</span><span class="p">,</span> <span class="n">unload</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">}</span>
<span class="nf">if </span><span class="p">(</span><span class="s">&quot;h2o&quot;</span> <span class="o">%in%</span> <span class="nf">rownames</span><span class="p">(</span><span class="nf">installed.packages</span><span class="p">()))</span> <span class="p">{</span> <span class="nf">remove.packages</span><span class="p">(</span><span class="s">&quot;h2o&quot;</span><span class="p">)</span> <span class="p">}</span>

<span class="c1"># Install packages H2O depends on</span>
<span class="n">pkgs</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;methods&quot;</span><span class="p">,</span> <span class="s">&quot;statmod&quot;</span><span class="p">,</span> <span class="s">&quot;stats&quot;</span><span class="p">,</span> <span class="s">&quot;graphics&quot;</span><span class="p">,</span> <span class="s">&quot;RCurl&quot;</span><span class="p">,</span> <span class="s">&quot;jsonlite&quot;</span><span class="p">,</span> <span class="s">&quot;tools&quot;</span><span class="p">,</span> <span class="s">&quot;utils&quot;</span><span class="p">)</span>
<span class="nf">for </span><span class="p">(</span><span class="n">pkg</span> <span class="n">in</span> <span class="n">pkgs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">pkg</span> <span class="o">%in%</span> <span class="nf">rownames</span><span class="p">(</span><span class="nf">installed.packages</span><span class="p">())))</span> <span class="p">{</span> <span class="nf">install.packages</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="install-h2o-from-cran">
<h3>Install H2O from CRAN<a class="headerlink" href="#install-h2o-from-cran" title="Permalink to this headline">¶</a></h3>
<p>In case of installation from CRAN, the typical <code class="docutils literal notranslate"><span class="pre">install.packages(&quot;h2o&quot;,</span> <span class="pre">&quot;3.36.1.4&quot;)</span></code> command can be used. Please note
that the latest released version might not be available in CRAN. In that case, please install H2O from S3.</p>
</div>
<div class="section" id="install-h2o-from-s3">
<h3>Install H2O from S3<a class="headerlink" href="#install-h2o-from-s3" title="Permalink to this headline">¶</a></h3>
<p>H2O can be also installed from the hosted R repository in H2O’s S3 buckets.</p>
<p>At present, you can install the <strong>h2o</strong> R package using a repository URL comprised
of the H2O version name and number. Example: <cite>http://h2o-release.s3.amazonaws.com/h2o/rel-zumbo/4/R</cite></p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download, install, and initialize the H2O package for R.</span>
<span class="c1"># In this case we are using rel-zumbo 4 (3.36.1.4)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;h2o&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/h2o/rel-zumbo/4/R&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="install-rsparkling">
<h2>Install RSparkling<a class="headerlink" href="#install-rsparkling" title="Permalink to this headline">¶</a></h2>
<p>RSparkling can be installed from hosted R repository in Sparkling Water’s S3 buckets
from the link <cite>http://h2o-release.s3.amazonaws.com/sparkling-water/spark-3.1/3.36.1.4-1-3.1/R</cite> as:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download, install, and initialize the RSparkling</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;rsparkling&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;http://h2o-release.s3.amazonaws.com/sparkling-water/spark-3.1/3.36.1.4-1-3.1/R&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="enable-rsparkling">
<h2>Enable RSparkling<a class="headerlink" href="#enable-rsparkling" title="Permalink to this headline">¶</a></h2>
<p>The call to <code class="docutils literal notranslate"><span class="pre">library(rsparkling)</span></code> automatically registers the Sparkling Water extension. This needs
to be called before the <code class="docutils literal notranslate"><span class="pre">spark_connect</span></code> method.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">rsparkling</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="starting-spark">
<h2>Starting Spark<a class="headerlink" href="#starting-spark" title="Permalink to this headline">¶</a></h2>
<p>Once we’ve installed <strong>rsparkling</strong> and its dependencies, the first step would be to create a Spark connection as follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span> <span class="o">&lt;-</span> <span class="nf">spark_connect</span><span class="p">(</span><span class="n">master</span> <span class="o">=</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.1.3&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Note</strong>: If you are running on Databricks, please use the following code instead:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span> <span class="o">&lt;-</span> <span class="nf">spark_connect</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s">&quot;databricks&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>NOTE</strong>: Please be sure to set <code class="docutils literal notranslate"><span class="pre">version</span></code> to the proper Spark version utilized by your version of Sparkling Water in <code class="docutils literal notranslate"><span class="pre">spark_connect()</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">spark_connect</span></code> method has also <code class="docutils literal notranslate"><span class="pre">spark_home</span></code> argument which defaults to the <code class="docutils literal notranslate"><span class="pre">SPARK_HOME</span></code> environment
variable. If <code class="docutils literal notranslate"><span class="pre">SPARK_HOME</span></code> is defined it will be always used unless the <code class="docutils literal notranslate"><span class="pre">version</span></code>
parameter is specified to force the use of a locally installed version. Therefore, to use existing
Spark, please run:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span> <span class="o">&lt;-</span> <span class="nf">spark_connect</span><span class="p">(</span><span class="n">master</span> <span class="o">=</span> <span class="s">&quot;local&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="using-rsparkling">
<h2>Using RSparkling<a class="headerlink" href="#using-rsparkling" title="Permalink to this headline">¶</a></h2>
<div class="section" id="specify-h2oconf">
<h3>Specify H2OConf<a class="headerlink" href="#specify-h2oconf" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">H2OConf</span></code> contains all settings needed the start and run the H2O-3 cluster.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">h2oConf</span> <span class="o">&lt;-</span> <span class="nf">H2OConf</span><span class="p">()</span>
</pre></div>
</div>
<p>The newly created instance of <code class="docutils literal notranslate"><span class="pre">H2OConf</span></code> contains SW defaults affected by property values specified in <code class="docutils literal notranslate"><span class="pre">spark-defaults.conf</span></code>.
If you want to change a value of a given property, use an appropriate setter listed in <a class="reference internal" href="configuration/configuration_properties.html#sw-config-properties"><span class="std std-ref">Sparkling Water Configuration Properties</span></a>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">h2oConf</span><span class="o">$</span><span class="nf">setBasePort</span><span class="p">(</span><span class="m">55555</span><span class="p">)</span>
</pre></div>
</div>
<p>Or you change the property value via the <code class="docutils literal notranslate"><span class="pre">set</span></code> method and specifying the property name.:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">h2oConf</span><span class="o">$</span><span class="nf">set</span><span class="p">(</span><span class="s">&quot;spark.ext.h2o.cloud.name&quot;</span><span class="p">,</span> <span class="s">&quot;mycloud&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="create-h2ocontext">
<h3>Create H2OContext<a class="headerlink" href="#create-h2ocontext" title="Permalink to this headline">¶</a></h3>
<p>To create H2OContext, call:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">hc</span> <span class="o">&lt;-</span> <span class="nf">H2OContext.getOrCreate</span><span class="p">(</span><span class="n">h2oConf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="open-h2o-flow">
<h3>Open H2O Flow<a class="headerlink" href="#open-h2o-flow" title="Permalink to this headline">¶</a></h3>
<p>We can also view the H2O Flow web UI:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">hc</span><span class="o">$</span><span class="nf">openFlow</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="h2o-with-spark-dataframes">
<h3>H2O with Spark DataFrames<a class="headerlink" href="#h2o-with-spark-dataframes" title="Permalink to this headline">¶</a></h3>
<p>As an example, let’s copy the mtcars dataset to Spark so we can access it from H2O Sparkling Water:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="n">mtcars_tbl</span> <span class="o">&lt;-</span> <span class="nf">copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">mtcars</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="n">mtcars_tbl</span>

   <span class="c1">## Source:   query [?? x 11]</span>
   <span class="c1">## Database: spark connection master=local[8] app=sparklyr local=TRUE</span>
   <span class="c1">##</span>
   <span class="c1">##      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span>
   <span class="c1">##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
   <span class="c1">## 1   21.0     6 160.0   110  3.90 2.620 16.46     0     1     4     4</span>
   <span class="c1">## 2   21.0     6 160.0   110  3.90 2.875 17.02     0     1     4     4</span>
   <span class="c1">## 3   22.8     4 108.0    93  3.85 2.320 18.61     1     1     4     1</span>
   <span class="c1">## 4   21.4     6 258.0   110  3.08 3.215 19.44     1     0     3     1</span>
   <span class="c1">## 5   18.7     8 360.0   175  3.15 3.440 17.02     0     0     3     2</span>
   <span class="c1">## 6   18.1     6 225.0   105  2.76 3.460 20.22     1     0     3     1</span>
   <span class="c1">## 7   14.3     8 360.0   245  3.21 3.570 15.84     0     0     3     4</span>
   <span class="c1">## 8   24.4     4 146.7    62  3.69 3.190 20.00     1     0     4     2</span>
   <span class="c1">## 9   22.8     4 140.8    95  3.92 3.150 22.90     1     0     4     2</span>
   <span class="c1">## 10  19.2     6 167.6   123  3.92 3.440 18.30     1     0     4     4</span>
   <span class="c1">## ... with more rows</span>
</pre></div>
</div>
<p>The use case we’d like to enable is calling the H2O algorithms and feature transformers directly on Spark DataFrames
that we’ve manipulated with dplyr. This is indeed supported by the Sparkling Water package.
Here is how you convert a Spark DataFrame into an H2O Frame:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mtcars_hf</span> <span class="o">&lt;-</span> <span class="n">hc</span><span class="o">$</span><span class="nf">asH2OFrame</span><span class="p">(</span><span class="n">mtcars_tbl</span><span class="p">)</span>
<span class="n">mtcars_hf</span>

   <span class="c1">## &lt;jobj[103]&gt;</span>
   <span class="c1">##   class water.fvec.H2OFrame</span>
   <span class="c1">##   Frame frame_rdd_39 (32 rows and 11 cols):</span>
   <span class="c1">##                        mpg  cyl                disp   hp                drat                  wt                qsec  vs  am  gear  carb</span>
   <span class="c1">##     min               10.4    4                71.1   52                2.76               1.513                14.5   0   0     3     1</span>
   <span class="c1">##    mean          20.090625    6          230.721875  146           3.5965625             3.21725  17.848750000000003   0   0     3     2</span>
   <span class="c1">##  stddev  6.026948052089104    1  123.93869383138194   68  0.5346787360709715  0.9784574429896966  1.7869432360968436   0   0     0     1</span>
   <span class="c1">##     max               33.9    8               472.0  335                4.93               5.424                22.9   1   1     5     8</span>
   <span class="c1">## missing                0.0    0                 0.0    0                 0.0                 0.0                 0.0   0   0     0     0</span>
   <span class="c1">##       0               21.0    6               160.0  110                 3.9                2.62               16.46   0   1     4     4</span>
   <span class="c1">##       1               21.0    6               160.0  110                 3.9               2.875               17.02   0   1     4     4</span>
   <span class="c1">##       2               22.8    4               108.0   93                3.85                2.32               18.61   1   1     4     1</span>
   <span class="c1">##       3               21.4    6               258.0  110                3.08               3.215               19.44   1   0     3     1</span>
   <span class="c1">##       4               18.7    8               360.0  175                3.15                3.44               17.02   0   0     3     2</span>
   <span class="c1">##       5               18.1    6               225.0  105                2.76                3.46               20.22   1   0     3     1</span>
   <span class="c1">##       6               14.3    8               360.0  245                3.21                3.57               15.84   0   0     3     4</span>
   <span class="c1">##       7               24.4    4               146.7   62                3.69                3.19                20.0   1   0     4     2</span>
   <span class="c1">##       8               22.8    4               140.8   95                3.92                3.15                22.9   1   0     4     2</span>
   <span class="c1">##       9               19.2    6               167.6  123                3.92                3.44                18.3   1   0     4     4</span>
   <span class="c1">##      10               17.8    6               167.6  123                3.92                3.44                18.9   1   0     4     4</span>
   <span class="c1">##      11               16.4    8               275.8  180                3.07                4.07                17.4   0   0     3     3</span>
   <span class="c1">##      12               17.3    8               275.8  180                3.07                3.73                17.6   0   0     3     3</span>
   <span class="c1">##      13               15.2    8               275.8  180                3.07                3.78                18.0   0   0     3     3</span>
   <span class="c1">##      14               10.4    8               472.0  205                2.93                5.25               17.98   0   0     3     4</span>
   <span class="c1">##      15               10.4    8               460.0  215                 3.0               5.424               17.82   0   0     3     4</span>
   <span class="c1">##      16               14.7    8               440.0  230                3.23               5.345               17.42   0   0     3     4</span>
   <span class="c1">##      17               32.4    4                78.7   66                4.08                 2.2               19.47   1   1     4     1</span>
   <span class="c1">##      18               30.4    4                75.7   52                4.93               1.615               18.52   1   1     4     2</span>
   <span class="c1">##      19               33.9    4                71.1   65                4.22               1.835                19.9   1   1     4     1</span>
</pre></div>
</div>
</div>
<div class="section" id="obtaining-logs">
<h3>Obtaining Logs<a class="headerlink" href="#obtaining-logs" title="Permalink to this headline">¶</a></h3>
<p>Look at the Spark log from R:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">spark_log</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="m">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="disconnect-from-spark">
<h3>Disconnect from Spark<a class="headerlink" href="#disconnect-from-spark" title="Permalink to this headline">¶</a></h3>
<p>Now we disconnect from Spark, this will result in the H2OContext being stopped as well
since it’s owned by the Spark shell process used by our Spark connection:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">spark_disconnect</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="machine-learning-with-rsparkling-h2o">
<h2>Machine Learning with RSparkling &amp; H2O<a class="headerlink" href="#machine-learning-with-rsparkling-h2o" title="Permalink to this headline">¶</a></h2>
<p>Using the same mtcars dataset, here is an example where we train a Gradient Boosting Machine
(GBM) to predict “mpg”.</p>
<div class="section" id="initialize-h2o">
<h3>Initialize H2O<a class="headerlink" href="#initialize-h2o" title="Permalink to this headline">¶</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">h2o</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="data-preparations">
<h3>Data Preparations<a class="headerlink" href="#data-preparations" title="Permalink to this headline">¶</a></h3>
<p>Define the response, <cite>y</cite>, and set of predictor variables, <cite>x</cite>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">&lt;-</span> <span class="s">&quot;mpg&quot;</span>
<span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">setdiff</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">mtcars_hf</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s split the data into a train and test set using H2O. The <code class="docutils literal notranslate"><span class="pre">h2o.splitFrame</span></code>
function defaults to a 75-25 split (<code class="docutils literal notranslate"><span class="pre">ratios</span> <span class="pre">=</span> <span class="pre">0.75</span></code>), but here we will make a 70-30 train-test split:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split the mtcars H2O Frame into train &amp; test sets</span>
<span class="n">splits</span> <span class="o">&lt;-</span> <span class="nf">h2o.splitFrame</span><span class="p">(</span><span class="n">mtcars_hf</span><span class="p">,</span> <span class="n">ratios</span> <span class="o">=</span> <span class="m">0.7</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="model-training">
<h3>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline">¶</a></h3>
<p>Now train an H2O GBM using the training H2OFrame.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">fit</span> <span class="o">&lt;-</span> <span class="nf">h2o.gbm</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span>
               <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
               <span class="n">training_frame</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span>
               <span class="n">min_rows</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
               <span class="n">seed</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>

   <span class="c1">## H2ORegressionModel: gbm</span>
   <span class="c1">## Model ID:  GBM_model_R_1474763476171_1</span>
   <span class="c1">## Model Summary:</span>
   <span class="c1">##  number_of_trees number_of_internal_trees model_size_in_bytes min_depth</span>
   <span class="c1">##   1              50                       50               14807         5</span>
   <span class="c1">##  max_depth mean_depth min_leaves max_leaves mean_leaves</span>
   <span class="c1">##   1         5    5.00000         17         21    18.64000</span>
   <span class="c1">##</span>
   <span class="c1">##</span>
   <span class="c1">## H2ORegressionMetrics: gbm</span>
   <span class="c1">## ** Reported on training data. **</span>
   <span class="c1">##</span>
   <span class="c1">## MSE:  0.001211724</span>
   <span class="c1">## RMSE:  0.03480983</span>
   <span class="c1">## MAE:  0.02761402</span>
   <span class="c1">## RMSLE:  0.001929304</span>
   <span class="c1">## Mean Residual Deviance :  0.001211724</span>
</pre></div>
</div>
</div>
<div class="section" id="model-performance">
<h3>Model Performance:<a class="headerlink" href="#model-performance" title="Permalink to this headline">¶</a></h3>
<p>We can evaluate the performance of the GBM by evaluating its performance on a test set.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">perf</span> <span class="o">&lt;-</span> <span class="nf">h2o.performance</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span>

   <span class="c1">## H2ORegressionMetrics: gbm</span>
   <span class="c1">##</span>
   <span class="c1">## MSE:  2.707001</span>
   <span class="c1">## RMSE:  1.645297</span>
   <span class="c1">## MAE:  1.455267</span>
   <span class="c1">## RMSLE:  0.08579109</span>
   <span class="c1">## Mean Residual Deviance :  2.707001</span>
</pre></div>
</div>
</div>
<div class="section" id="predictions">
<h3>Predictions<a class="headerlink" href="#predictions" title="Permalink to this headline">¶</a></h3>
<p>To generate predictions on a test set, you do the following.
This will return an H2OFrame with a single (or multiple) columns of predicted values.
If regression, it will be a single column, if binary classification it will be 3 columns
and in multi-class prediction, it will be C+1 columns (where C is the number of classes).</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pred_hf</span> <span class="o">&lt;-</span> <span class="nf">h2o.predict</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span>
<span class="nf">head</span><span class="p">(</span><span class="n">pred_hf</span><span class="p">)</span>

   <span class="c1">##   predict</span>
   <span class="c1">## 1 21.39512</span>
   <span class="c1">## 2 16.92804</span>
   <span class="c1">## 3 15.19558</span>
   <span class="c1">## 4 20.47695</span>
   <span class="c1">## 5 20.47695</span>
   <span class="c1">## 6 15.24433</span>
</pre></div>
</div>
<p>Now let’s say you want to make this H2OFrame available to Spark. You can convert an H2OFrame into a Spark DataFrame using the <code class="docutils literal notranslate"><span class="pre">as_spark_dataframe</span></code> function:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pred_sdf</span> <span class="o">&lt;-</span> <span class="n">hc</span><span class="o">$</span><span class="nf">asSparkFrame</span><span class="p">(</span><span class="n">pred_hf</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">pred_sdf</span><span class="p">)</span>

   <span class="n">Source</span><span class="o">:</span>   <span class="n">query</span> <span class="p">[</span><span class="o">??</span> <span class="n">x</span> <span class="m">1</span><span class="p">]</span>
   <span class="n">Database</span><span class="o">:</span> <span class="n">spark</span> <span class="n">connection</span> <span class="n">master</span><span class="o">=</span><span class="n">local</span><span class="p">[</span><span class="m">8</span><span class="p">]</span> <span class="n">app</span><span class="o">=</span><span class="n">sparklyr</span> <span class="n">local</span><span class="o">=</span><span class="kc">TRUE</span>

   <span class="c1">##   predict</span>
   <span class="c1">##   &lt;dbl&gt;</span>
   <span class="c1">## 1 21.39512</span>
   <span class="c1">## 2 16.92804</span>
   <span class="c1">## 3 15.19558</span>
   <span class="c1">## 4 20.47695</span>
   <span class="c1">## 5 20.47695</span>
   <span class="c1">## 6 15.24433</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="additional-resources">
<h2>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.h2o.ai">Main documentation site</a></p></li>
<li><p><a class="reference external" href="http://h2o.ai">H2O.ai website</a></p></li>
<li><p><a class="reference external" href="https://github.com/h2oai/sparkling-water/blob/master/r/src/inst/examples/example_rsparkling.R">Example code</a></p></li>
<li><p><a class="reference external" href="http://docs.h2o.ai/sparkling-water/master/bleeding-edge/doc/deployment/rsparkling_on_windows.html">Troubleshooting RSparkling on Windows</a></p></li>
</ul>
<p>If you are new to H2O for machine learning, we recommend you start with:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/h2oai/h2o-tutorials/blob/master/h2o-open-tour-2016/chicago/intro-to-h2o.R">Intro to H2O Tutorial</a></p></li>
<li><p><a class="reference external" href="https://github.com/h2oai/h2o-tutorials/blob/master/h2o-open-tour-2016/chicago/grid-search-model-selection.R">H2O Grid Search &amp; Model Selection Tutorial</a></p></li>
</ul>
<p>There is also a number of other H2O R <a class="reference external" href="https://github.com/h2oai/h2o-tutorials">tutorials</a>, <a class="reference external" href="https://github.com/h2oai/h2o-3/tree/master/h2o-r/demos">demos</a> available, and the <a class="reference external" href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/booklets/RBooklet.pdf">Machine Learning with R and
H2O Booklet (pdf)</a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="migration_guide.html" class="btn btn-neutral float-right" title="Migration Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pysparkling.html" class="btn btn-neutral float-left" title="PySparkling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020 H2O.ai
      <span class="lastupdated">
        Last updated on Aug 04, 2022.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>